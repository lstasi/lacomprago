# LaComprago - Data Models

## Overview

This document defines the data models and entities used throughout the LaComprago application. Models are organized by domain and include both local database entities and API response models.

## Domain Models

### 1. Authentication Domain

#### AuthToken
```kotlin
data class AuthToken(
    val accessToken: String,
    val refreshToken: String?,
    val tokenType: String,
    val expiresIn: Long,
    val expiresAt: Long,
    val scope: String?
)
```

#### User
```kotlin
data class User(
    val id: String,
    val email: String,
    val name: String?,
    val createdAt: Long
)
```

### 2. Order Domain

#### Order
```kotlin
data class Order(
    val id: String,
    val orderNumber: String,
    val orderDate: Long,
    val totalAmount: Double,
    val currency: String,
    val status: OrderStatus,
    val items: List<OrderItem>,
    val storeId: String?,
    val storeName: String?
)

enum class OrderStatus {
    COMPLETED,
    CANCELLED,
    REFUNDED,
    PROCESSING
}
```

#### OrderItem
```kotlin
data class OrderItem(
    val id: String,
    val orderId: String,
    val productId: String,
    val productName: String,
    val quantity: Int,
    val unitPrice: Double,
    val totalPrice: Double,
    val category: String?,
    val brand: String?,
    val unit: String? // e.g., "kg", "liter", "unit"
)
```

### 3. Product Domain

#### Product
```kotlin
data class Product(
    val id: String,
    val name: String,
    val category: String?,
    val brand: String?,
    val unit: String?,
    val averagePrice: Double,
    val currentPrice: Double?
)
```

#### ProductStatistics
```kotlin
data class ProductStatistics(
    val productId: String,
    val productName: String,
    val purchaseFrequency: Int, // Total times purchased
    val lastPurchaseDate: Long,
    val firstPurchaseDate: Long,
    val averageQuantityPerOrder: Double,
    val totalQuantityPurchased: Double,
    val averagePrice: Double,
    val category: String?,
    val brand: String?,
    val purchaseIntervalDays: Double? // Average days between purchases
)
```

#### ProductFrequencyAnalysis
```kotlin
data class ProductFrequencyAnalysis(
    val product: Product,
    val statistics: ProductStatistics,
    val frequencyScore: Double, // 0.0 to 1.0, calculated metric
    val recommendationLevel: RecommendationLevel
)

enum class RecommendationLevel {
    ESSENTIAL,    // Very high frequency
    REGULAR,      // Regular purchases
    OCCASIONAL,   // Bought sometimes
    RARE          // Rarely purchased
}
```

### 4. Shopping Cart Domain

#### ShoppingCart
```kotlin
data class ShoppingCart(
    val id: String,
    val createdAt: Long,
    val updatedAt: Long,
    val status: CartStatus,
    val items: List<CartItem>,
    val totalAmount: Double,
    val isAutoGenerated: Boolean,
    val submittedAt: Long?
)

enum class CartStatus {
    DRAFT,
    SUBMITTED,
    PROCESSING,
    COMPLETED,
    CANCELLED
}
```

#### CartItem
```kotlin
data class CartItem(
    val id: String,
    val cartId: String,
    val productId: String,
    val productName: String,
    val quantity: Int,
    val unit: String?,
    val estimatedPrice: Double,
    val category: String?,
    val addedAt: Long,
    val isManuallyAdded: Boolean
)
```

## Database Entities (Room)

### 1. OrderEntity
```kotlin
@Entity(tableName = "orders")
data class OrderEntity(
    @PrimaryKey
    val id: String,
    val orderNumber: String,
    val orderDate: Long,
    val totalAmount: Double,
    val currency: String,
    val status: String,
    val storeId: String?,
    val storeName: String?,
    val syncedAt: Long,
    val lastModified: Long
)
```

### 2. OrderItemEntity
```kotlin
@Entity(
    tableName = "order_items",
    foreignKeys = [
        ForeignKey(
            entity = OrderEntity::class,
            parentColumns = ["id"],
            childColumns = ["orderId"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [Index("orderId"), Index("productId")]
)
data class OrderItemEntity(
    @PrimaryKey
    val id: String,
    val orderId: String,
    val productId: String,
    val productName: String,
    val quantity: Int,
    val unitPrice: Double,
    val totalPrice: Double,
    val category: String?,
    val brand: String?,
    val unit: String?
)
```

### 3. ProductEntity
```kotlin
@Entity(tableName = "products")
data class ProductEntity(
    @PrimaryKey
    val id: String,
    val name: String,
    val category: String?,
    val brand: String?,
    val unit: String?,
    val averagePrice: Double,
    val currentPrice: Double?,
    val lastUpdated: Long
)
```

### 4. ProductStatisticsEntity
```kotlin
@Entity(
    tableName = "product_statistics",
    foreignKeys = [
        ForeignKey(
            entity = ProductEntity::class,
            parentColumns = ["id"],
            childColumns = ["productId"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [Index("productId"), Index("lastPurchaseDate")]
)
data class ProductStatisticsEntity(
    @PrimaryKey
    val productId: String,
    val purchaseFrequency: Int,
    val lastPurchaseDate: Long,
    val firstPurchaseDate: Long,
    val averageQuantityPerOrder: Double,
    val totalQuantityPurchased: Double,
    val averagePrice: Double,
    val purchaseIntervalDays: Double?,
    val calculatedAt: Long
)
```

### 5. ShoppingCartEntity
```kotlin
@Entity(tableName = "shopping_carts")
data class ShoppingCartEntity(
    @PrimaryKey
    val id: String,
    val createdAt: Long,
    val updatedAt: Long,
    val status: String,
    val totalAmount: Double,
    val isAutoGenerated: Boolean,
    val submittedAt: Long?
)
```

### 6. CartItemEntity
```kotlin
@Entity(
    tableName = "cart_items",
    foreignKeys = [
        ForeignKey(
            entity = ShoppingCartEntity::class,
            parentColumns = ["id"],
            childColumns = ["cartId"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [Index("cartId"), Index("productId")]
)
data class CartItemEntity(
    @PrimaryKey
    val id: String,
    val cartId: String,
    val productId: String,
    val productName: String,
    val quantity: Int,
    val unit: String?,
    val estimatedPrice: Double,
    val category: String?,
    val addedAt: Long,
    val isManuallyAdded: Boolean
)
```

## API Request/Response Models

### 1. Authentication API

#### TokenRequest
```kotlin
data class TokenRequest(
    val grant_type: String,
    val code: String?,
    val refresh_token: String?,
    val client_id: String,
    val redirect_uri: String?
)
```

#### TokenResponse
```kotlin
data class TokenResponse(
    val access_token: String,
    val refresh_token: String?,
    val token_type: String,
    val expires_in: Long,
    val scope: String?
)
```

### 2. Orders API

#### OrdersResponse
```kotlin
data class OrdersResponse(
    val orders: List<OrderDto>,
    val total: Int,
    val page: Int,
    val pageSize: Int,
    val hasMore: Boolean
)
```

#### OrderDto
```kotlin
data class OrderDto(
    val id: String,
    val order_number: String,
    val order_date: String, // ISO 8601 format
    val total_amount: Double,
    val currency: String,
    val status: String,
    val items: List<OrderItemDto>,
    val store_id: String?,
    val store_name: String?
)
```

#### OrderItemDto
```kotlin
data class OrderItemDto(
    val id: String,
    val product_id: String,
    val product_name: String,
    val quantity: Int,
    val unit_price: Double,
    val total_price: Double,
    val category: String?,
    val brand: String?,
    val unit: String?
)
```

### 3. Shopping Cart API

#### CreateCartRequest
```kotlin
data class CreateCartRequest(
    val items: List<CartItemRequest>
)
```

#### CartItemRequest
```kotlin
data class CartItemRequest(
    val product_id: String,
    val quantity: Int
)
```

#### CreateCartResponse
```kotlin
data class CreateCartResponse(
    val cart_id: String,
    val status: String,
    val created_at: String,
    val items: List<CartItemDto>,
    val total_amount: Double
)
```

#### CartItemDto
```kotlin
data class CartItemDto(
    val product_id: String,
    val product_name: String,
    val quantity: Int,
    val price: Double,
    val total: Double
)
```

## UI State Models

### 1. OrderHistoryUiState
```kotlin
sealed class OrderHistoryUiState {
    object Loading : OrderHistoryUiState()
    data class Success(
        val orders: List<Order>,
        val hasMore: Boolean
    ) : OrderHistoryUiState()
    data class Error(val message: String) : OrderHistoryUiState()
}
```

### 2. StatisticsUiState
```kotlin
sealed class StatisticsUiState {
    object Loading : StatisticsUiState()
    data class Success(
        val products: List<ProductFrequencyAnalysis>,
        val sortBy: SortOption
    ) : StatisticsUiState()
    data class Error(val message: String) : StatisticsUiState()
}

enum class SortOption {
    FREQUENCY_DESC,
    LAST_PURCHASE_DESC,
    NAME_ASC,
    CATEGORY_ASC
}
```

### 3. CartUiState
```kotlin
sealed class CartUiState {
    object Loading : CartUiState()
    data class Editing(
        val cart: ShoppingCart,
        val canSubmit: Boolean
    ) : CartUiState()
    data class Submitting(val cart: ShoppingCart) : CartUiState()
    data class Submitted(val cartId: String) : CartUiState()
    data class Error(val message: String) : CartUiState()
}
```

### 4. AuthUiState
```kotlin
sealed class AuthUiState {
    object LoggedOut : AuthUiState()
    object Authenticating : AuthUiState()
    data class Authenticated(val user: User) : AuthUiState()
    data class Error(val message: String) : AuthUiState()
}
```

## Data Mappers

Data mappers convert between different model types:

```kotlin
// Entity to Domain
fun OrderEntity.toDomain(items: List<OrderItemEntity>): Order

// Domain to Entity
fun Order.toEntity(): OrderEntity

// DTO to Domain
fun OrderDto.toDomain(): Order

// Domain to DTO
fun ShoppingCart.toCreateCartRequest(): CreateCartRequest
```

## Data Validation

### Validation Rules

**Order**
- `id`: Non-empty string
- `orderDate`: Valid timestamp
- `totalAmount`: Non-negative
- `items`: Non-empty list

**ProductStatistics**
- `purchaseFrequency`: Positive integer
- `lastPurchaseDate`: Valid timestamp, not in future
- `averagePrice`: Non-negative

**ShoppingCart**
- `items`: Non-empty list for submission
- `totalAmount`: Non-negative
- Each `CartItem.quantity`: Positive integer

## Data Relationships

```
Order (1) ──────┬─── (Many) OrderItem
                │
ProductStatistics (1) ─── (1) Product
                │
                └─── Derived from ─── OrderItem
                
ShoppingCart (1) ─── (Many) CartItem
                │
CartItem (Many) ─── (1) Product
```

## Indexing Strategy

### Database Indexes

**Performance Optimization**
- `orders.orderDate`: For date range queries
- `order_items.orderId`: For joining with orders
- `order_items.productId`: For product statistics
- `product_statistics.lastPurchaseDate`: For sorting
- `cart_items.cartId`: For cart retrieval

## Data Retention Policy

**Local Storage**
- Orders: Keep last 12 months
- Product Statistics: Recalculate monthly
- Shopping Carts: Keep submitted carts for 30 days
- Draft Carts: Keep for 7 days

## Conclusion

These data models provide a complete representation of the application's domain, ensuring type safety, clear relationships, and efficient data operations throughout the LaComprago application.
